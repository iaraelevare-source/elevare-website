version: '3.8'

services:
  # Evolution API - WhatsApp não oficial (GRÁTIS)
  # Documentação: https://doc.evolution-api.com
  evolution-api:
    image: atendai/evolution-api:latest
    container_name: elevare-whatsapp-mock
    restart: unless-stopped
    ports:
      - "3002:8080"
    environment:
      # Configurações básicas
      - SERVER_TYPE=http
      - SERVER_PORT=8080
      - SERVER_URL=http://localhost:3002
      
      # Autenticação (API Key)
      - AUTHENTICATION_TYPE=apikey
      - AUTHENTICATION_API_KEY=${WHATSAPP_MOCK_API_KEY:-elevare_mock_key_123}
      - AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES=true
      
      # Banco de dados (SQLite para simplicidade)
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=sqlite
      - DATABASE_CONNECTION_URI=file:./evolution.db
      
      # Webhook (enviar mensagens recebidas para o backend)
      - WEBHOOK_GLOBAL_URL=http://host.docker.internal:3000/webhooks/whatsapp
      - WEBHOOK_GLOBAL_ENABLED=true
      - WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS=true
      
      # Eventos que serão enviados ao webhook
      - WEBHOOK_EVENTS_APPLICATION_STARTUP=false
      - WEBHOOK_EVENTS_QRCODE_UPDATED=true
      - WEBHOOK_EVENTS_MESSAGES_SET=true
      - WEBHOOK_EVENTS_MESSAGES_UPSERT=true
      - WEBHOOK_EVENTS_MESSAGES_UPDATE=true
      - WEBHOOK_EVENTS_MESSAGES_DELETE=false
      - WEBHOOK_EVENTS_SEND_MESSAGE=false
      - WEBHOOK_EVENTS_CONTACTS_SET=true
      - WEBHOOK_EVENTS_CONTACTS_UPSERT=true
      - WEBHOOK_EVENTS_CONTACTS_UPDATE=true
      - WEBHOOK_EVENTS_PRESENCE_UPDATE=false
      - WEBHOOK_EVENTS_CHATS_SET=true
      - WEBHOOK_EVENTS_CHATS_UPSERT=true
      - WEBHOOK_EVENTS_CHATS_UPDATE=true
      - WEBHOOK_EVENTS_CHATS_DELETE=false
      - WEBHOOK_EVENTS_GROUPS_UPSERT=false
      - WEBHOOK_EVENTS_GROUPS_UPDATE=false
      - WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE=false
      - WEBHOOK_EVENTS_CONNECTION_UPDATE=true
      - WEBHOOK_EVENTS_CALL=false
      - WEBHOOK_EVENTS_NEW_JWT_TOKEN=false
      
      # Configurações do WhatsApp
      - CONFIG_SESSION_PHONE_CLIENT=Elevare
      - CONFIG_SESSION_PHONE_NAME=Chrome
      
      # Logs
      - LOG_LEVEL=ERROR
      - LOG_COLOR=true
      - LOG_BAILEYS=error
      
    volumes:
      # Persistir instâncias do WhatsApp
      - ./evolution-instances:/evolution/instances
      - ./evolution-store:/evolution/store
    
    networks:
      - elevare-network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  elevare-network:
    driver: bridge

# Como usar:
# 1. Suba o container:
#    docker-compose -f docker-compose.whatsapp-mock.yml up -d
#
# 2. Crie uma instância:
#    curl -X POST http://localhost:3002/instance/create \
#      -H "apikey: elevare_mock_key_123" \
#      -H "Content-Type: application/json" \
#      -d '{"instanceName":"elevare","token":"elevare_token","qrcode":true}'
#
# 3. Obtenha QR Code:
#    curl http://localhost:3002/instance/connect/elevare \
#      -H "apikey: elevare_mock_key_123"
#
# 4. Escaneie o QR Code com seu WhatsApp
#
# 5. Envie mensagem de teste:
#    curl -X POST http://localhost:3002/message/sendText/elevare \
#      -H "apikey: elevare_mock_key_123" \
#      -H "Content-Type: application/json" \
#      -d '{"number":"5511999999999","text":"Teste do Elevare!"}'
